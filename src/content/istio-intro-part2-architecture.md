---
title: "Istio 아키텍처 완전 정복"
excerpt: "Control Plane과 Data Plane이 정확히 뭘 하는지, Sidecar가 어떻게 트래픽을 가로채는지, Pod 간 요청이 실제로 어떤 경로로 흐르는지"
category: "kubernetes"
tags:
  - istio
  - envoy
  - sidecar
  - control-plane
  - data-plane
  - kubernetes
series:
  name: "istio-intro"
  order: 2
date: "2025-12-07"
---

## 🎯 이전 글 요약

Part 1에서는 Service Mesh가 왜 필요한지, 라이브러리 방식과 뭐가 다른지 정리했습니다.

**핵심 내용:**
- 마이크로서비스 = 네트워크 복잡도 증가
- 라이브러리 방식: 언어별 구현, 코드에 섞임
- Service Mesh: 네트워크 로직을 Sidecar로 분리

Part 2에서는 **Istio가 내부적으로 어떻게 동작하는지** 파헤쳐보겠습니다.

---

## 💡 학습 동기

Part 1에서 개념은 이해했지만, "그래서 정확히 어떻게 동작하는데?"라는 의문이 남았습니다.

**궁금했던 것:**
- Sidecar가 트래픽을 가로챈다는데 어떻게?
- Control Plane이 뭐고 Data Plane이 뭔데?
- mTLS가 자동으로 된다는데 누가 인증서를 관리해?
- Pod A → Pod B 요청이 실제로 어떤 경로로?

---

## 🏗️ Istio 아키텍처 전체 구조

Istio는 크게 **두 개의 영역**으로 나뉩니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Istio Architecture                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                    CONTROL PLANE                            │   │
│   │                                                             │   │
│   │   ┌───────────────────────────────────────────────────┐     │   │
│   │   │                    istiod                         │     │   │
│   │   │  ┌─────────┐  ┌─────────┐  ┌─────────────────┐   │     │   │
│   │   │  │  Pilot  │  │ Citadel │  │     Galley      │   │     │   │
│   │   │  │ (설정)  │  │ (인증서)│  │ (설정 검증)     │   │     │   │
│   │   │  └─────────┘  └─────────┘  └─────────────────┘   │     │   │
│   │   └───────────────────────────────────────────────────┘     │   │
│   │                            │                                │   │
│   │                            │ xDS API                        │   │
│   │                            ▼                                │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                     DATA PLANE                              │   │
│   │                                                             │   │
│   │   ┌───────────────┐         ┌───────────────┐               │   │
│   │   │     Pod A     │         │     Pod B     │               │   │
│   │   │ ┌───────────┐ │         │ ┌───────────┐ │               │   │
│   │   │ │    App    │ │         │ │    App    │ │               │   │
│   │   │ └─────┬─────┘ │         │ └─────┬─────┘ │               │   │
│   │   │       │       │         │       │       │               │   │
│   │   │ ┌─────▼─────┐ │  mTLS   │ ┌─────▼─────┐ │               │   │
│   │   │ │   Envoy   │◄├─────────┼─►   Envoy   │ │               │   │
│   │   │ │ (Sidecar) │ │         │ │ (Sidecar) │ │               │   │
│   │   │ └───────────┘ │         │ └───────────┘ │               │   │
│   │   └───────────────┘         └───────────────┘               │   │
│   │                                                             │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🧠 Control Plane: istiod

istiod는 Istio의 두뇌입니다. 예전에는 Pilot, Citadel, Galley가 별도 컴포넌트였지만, 지금은 istiod 하나로 통합되었습니다.

### istiod가 하는 일

```
┌─────────────────────────────────────────────────────────────────────┐
│                        istiod 역할                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   1️⃣ 설정 관리 (Pilot)                                             │
│   ════════════════════                                              │
│   • VirtualService, DestinationRule 등 Istio 리소스 감시            │
│   • Kubernetes Service, Endpoint 정보 수집                          │
│   • 이 정보들을 Envoy가 이해할 수 있는 형태로 변환                   │
│                                                                     │
│   2️⃣ 인증서 관리 (Citadel)                                          │
│   ════════════════════════                                          │
│   • 각 워크로드에 대한 인증서 발급                                   │
│   • 인증서 자동 갱신                                                 │
│   • SPIFFE 기반 서비스 신원(Identity) 부여                          │
│                                                                     │
│   3️⃣ 설정 검증 (Galley)                                             │
│   ═══════════════════════                                           │
│   • YAML 유효성 검사                                                 │
│   • 잘못된 설정 배포 방지                                            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### xDS API

istiod와 Envoy는 **xDS API**로 통신합니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                          xDS API                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   istiod                                                            │
│     │                                                               │
│     ├──► LDS (Listener Discovery Service)                          │
│     │    → "이 포트로 들어오는 트래픽은 이렇게 처리해"               │
│     │                                                               │
│     ├──► RDS (Route Discovery Service)                              │
│     │    → "이 경로로 요청이 오면 여기로 보내"                       │
│     │                                                               │
│     ├──► CDS (Cluster Discovery Service)                            │
│     │    → "이 서비스의 엔드포인트들은 이거야"                       │
│     │                                                               │
│     ├──► EDS (Endpoint Discovery Service)                           │
│     │    → "각 엔드포인트의 IP:Port는 이거야"                        │
│     │                                                               │
│     └──► SDS (Secret Discovery Service)                             │
│          → "mTLS에 쓸 인증서는 이거야"                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**핵심**: istiod가 설정을 변경하면, xDS API를 통해 모든 Envoy에 실시간으로 전파됩니다. **재배포 없이 설정 변경 가능!**

---

## 🛡️ Data Plane: Envoy Sidecar

Envoy는 실제 트래픽을 처리하는 프록시입니다. 각 Pod에 Sidecar 컨테이너로 주입됩니다.

### Sidecar Injection

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Sidecar Injection 과정                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   1. Namespace에 라벨 추가                                          │
│      $ kubectl label namespace default istio-injection=enabled      │
│                                                                     │
│   2. Pod 생성 요청                                                  │
│      ┌─────────────────────────────────────────────┐                │
│      │  apiVersion: v1                             │                │
│      │  kind: Pod                                  │                │
│      │  spec:                                      │                │
│      │    containers:                              │                │
│      │    - name: my-app          ← 원래 컨테이너  │                │
│      │      image: my-app:latest                   │                │
│      └─────────────────────────────────────────────┘                │
│                          │                                          │
│                          ▼                                          │
│   3. Admission Controller가 가로챔                                  │
│                          │                                          │
│                          ▼                                          │
│   4. istio-init + istio-proxy 컨테이너 자동 추가                    │
│      ┌─────────────────────────────────────────────┐                │
│      │  spec:                                      │                │
│      │    initContainers:                          │                │
│      │    - name: istio-init    ← iptables 설정    │                │
│      │    containers:                              │                │
│      │    - name: my-app                           │                │
│      │    - name: istio-proxy   ← Envoy Sidecar    │                │
│      └─────────────────────────────────────────────┘                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### iptables로 트래픽 가로채기

**istio-init** 컨테이너가 iptables 규칙을 설정해서, 모든 트래픽이 Envoy를 거치게 만듭니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                    iptables 트래픽 가로채기                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   App Container                                                     │
│   ┌───────────────┐                                                 │
│   │  curl B:8080  │ ──► 원래 목적지: B 서비스 8080                  │
│   └───────────────┘                                                 │
│          │                                                          │
│          │  iptables REDIRECT                                       │
│          ▼                                                          │
│   ┌───────────────┐                                                 │
│   │ istio-proxy   │ ──► 실제로는 localhost:15001로 리다이렉트       │
│   │ (Envoy)       │                                                 │
│   │  :15001       │                                                 │
│   └───────┬───────┘                                                 │
│           │                                                         │
│           │  Envoy가 원래 목적지 확인 후 처리                        │
│           ▼                                                         │
│   실제 B 서비스로 요청 전송 (mTLS 적용)                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**앱 입장에서는 변화 없음!** 그냥 `curl B:8080` 하면 되고, 나머지는 Envoy가 처리합니다.

---

## 🔄 요청 흐름 완전 분석

Pod A의 앱이 Pod B의 앱을 호출하는 전체 과정입니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                  Pod A → Pod B 요청 흐름                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                          Pod A                              │    │
│  │  ┌───────────┐                                              │    │
│  │  │  App A    │ ─(1)─► curl B:8080                          │    │
│  │  └───────────┘                                              │    │
│  │        │                                                    │    │
│  │        │ (2) iptables가 15001로 리다이렉트                   │    │
│  │        ▼                                                    │    │
│  │  ┌───────────┐                                              │    │
│  │  │  Envoy A  │ (3) 목적지 확인, mTLS 인증서 준비            │    │
│  │  │  :15001   │     트레이싱 헤더 주입                       │    │
│  │  └─────┬─────┘                                              │    │
│  └────────┼────────────────────────────────────────────────────┘    │
│           │                                                         │
│           │ (4) mTLS 암호화된 요청                                  │
│           ▼                                                         │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                          Pod B                              │    │
│  │  ┌───────────┐                                              │    │
│  │  │  Envoy B  │ (5) mTLS 복호화, 인증서 검증                 │    │
│  │  │  :15006   │     AuthorizationPolicy 체크                 │    │
│  │  └─────┬─────┘                                              │    │
│  │        │                                                    │    │
│  │        │ (6) 로컬 App으로 전달                               │    │
│  │        ▼                                                    │    │
│  │  ┌───────────┐                                              │    │
│  │  │  App B    │ (7) 요청 처리                                │    │
│  │  │  :8080    │                                              │    │
│  │  └───────────┘                                              │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 각 단계 상세

| 단계 | 위치 | 설명 |
|------|------|------|
| 1 | App A | 그냥 HTTP 요청 (`curl B:8080`) |
| 2 | iptables | 15001 포트로 리다이렉트 |
| 3 | Envoy A | 목적지 확인, mTLS 준비, 헤더 주입 |
| 4 | 네트워크 | mTLS로 암호화된 통신 |
| 5 | Envoy B | 복호화, 인증서 검증, 인가 체크 |
| 6 | iptables | App B로 전달 |
| 7 | App B | 실제 비즈니스 로직 처리 |

**핵심**: App A, B 둘 다 mTLS를 모릅니다. Envoy가 알아서 처리합니다.

---

## 🔐 mTLS 자동화

### mTLS란?

```
┌─────────────────────────────────────────────────────────────────────┐
│                    TLS vs mTLS                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   TLS (단방향)                                                      │
│   ════════════                                                      │
│   Client ──────────────────► Server                                 │
│          "서버, 너 진짜 맞아?"  "응, 인증서 여기"                   │
│                                                                     │
│   • 클라이언트만 서버 검증                                          │
│   • HTTPS가 이 방식                                                 │
│                                                                     │
│   mTLS (상호 인증, Mutual TLS)                                      │
│   ═══════════════════════════                                       │
│   Client ◄─────────────────► Server                                 │
│          "서버, 너 진짜 맞아?"  "응, 근데 너도 증명해"              │
│          "내 인증서 여기"       "확인됨, 통신하자"                  │
│                                                                     │
│   • 양쪽 모두 서로 검증                                             │
│   • Zero Trust 환경에서 필수                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Istio에서 mTLS 자동화

istiod(Citadel)가 자동으로 인증서를 관리합니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                   mTLS 인증서 자동화                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   istiod (Citadel)                                                  │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  1. 워크로드 시작 감지                                      │   │
│   │  2. SPIFFE ID 기반 인증서 생성                              │   │
│   │     → spiffe://cluster.local/ns/default/sa/my-service       │   │
│   │  3. SDS API로 Envoy에 인증서 전달                           │   │
│   │  4. 24시간마다 자동 갱신                                    │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│                              │ SDS (Secret Discovery Service)       │
│                              ▼                                      │
│   ┌───────────────┐     ┌───────────────┐                           │
│   │    Envoy A    │     │    Envoy B    │                           │
│   │  인증서 저장  │     │  인증서 저장  │                           │
│   └───────────────┘     └───────────────┘                           │
│                                                                     │
│   개발자가 할 일: 없음!                                             │
│   인증서 발급, 갱신, 배포 모두 자동                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔍 Envoy 포트 구조

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Envoy 주요 포트                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   포트         용도                                                 │
│   ─────────────────────────────────────────────────────────────     │
│   15001       Outbound 트래픽 처리 (앱 → 외부)                     │
│   15006       Inbound 트래픽 처리 (외부 → 앱)                      │
│   15000       Envoy Admin (디버깅용)                               │
│   15020       Health Check, Prometheus 메트릭                      │
│   15021       Health Check 엔드포인트                              │
│   15090       Prometheus 메트릭 (자세한 것)                        │
│                                                                     │
│   디버깅할 때:                                                      │
│   $ kubectl exec -it pod/my-app -c istio-proxy -- \                │
│       curl localhost:15000/config_dump                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 📚 배운 점

### Control Plane (istiod)

1. **Pilot**: 설정을 Envoy가 이해할 수 있는 형태로 변환
2. **Citadel**: mTLS 인증서 자동 발급/갱신
3. **Galley**: 설정 유효성 검증
4. **xDS API**: 실시간 설정 배포 (재배포 불필요!)

### Data Plane (Envoy)

1. **Sidecar Injection**: Namespace 라벨로 자동 주입
2. **iptables**: 모든 트래픽을 Envoy로 리다이렉트
3. **투명한 프록시**: 앱은 변경 없이 그대로 사용

### mTLS 자동화

1. 인증서 발급, 갱신, 배포 모두 자동
2. SPIFFE 기반 서비스 신원
3. 개발자가 신경 쓸 필요 없음

---

## 🔗 다음 편 예고

Part 3에서는 Kubernetes Service와 Istio의 관계를 정리해보겠습니다.
- kube-proxy는 뭐고 Istio와 뭐가 다른지
- L4 로드밸런싱 vs L7 로드밸런싱
- 둘 다 필요한가?

---

## 📖 참고 자료

- [Istio Architecture 공식 문서](https://istio.io/latest/docs/ops/deployment/architecture/)
- [Envoy Proxy 공식 문서](https://www.envoyproxy.io/docs/envoy/latest/)
- [xDS Protocol](https://www.envoyproxy.io/docs/envoy/latest/api-docs/xds_protocol)
