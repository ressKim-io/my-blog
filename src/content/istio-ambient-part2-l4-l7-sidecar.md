---
title: "Istio Ambient Part 2: L4/L7 분리와 Sidecar 아키텍처 비교"
excerpt: "ztunnel과 waypoint의 역할 분담, HBONE 프로토콜, Sidecar 방식과의 상세 비교"
category: "kubernetes"
tags: ["istio", "ambient-mesh", "ztunnel", "waypoint", "l4-l7", "sidecar", "kubernetes"]
series:
  name: "istio-ambient"
  order: 2
date: "2024-12-24"
---

## 🎯 시작하며

Part 1에서 Ambient Mode의 개요를 배웠습니다. 이번에는 **L4/L7 분리**의 핵심 개념과 **Sidecar 아키텍처와의 차이**를 상세히 다룹니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                  이번 Part의 핵심 질문들                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. mTLS가 L4에서 처리된다는 게 무슨 의미?                     │
│                                                                 │
│   2. 언제 ztunnel만으로 충분하고, 언제 waypoint가 필요한가?     │
│                                                                 │
│   3. Sidecar 방식과 Ambient 방식의 트래픽 경로 차이는?          │
│                                                                 │
│   4. HBONE 프로토콜은 무엇인가?                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 💡 L4 vs L7 처리

### OSI 레이어 복습

```
┌─────────────────────────────────────────────────────────────────┐
│                    OSI 7계층과 처리 범위                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Layer 7 (Application)  ─┐                                     │
│   Layer 6 (Presentation)  ├─ L7 처리: waypoint                  │
│   Layer 5 (Session)      ─┘  • HTTP 라우팅                      │
│                              • 헤더 조작                        │
│                              • JWT 인증                         │
│   ────────────────────────────────────────                      │
│                                                                 │
│   Layer 4 (Transport)    ─── L4 처리: ztunnel                   │
│                              • TCP/UDP                          │
│                              • mTLS                             │
│                              • IP/포트 기반 정책                │
│   ────────────────────────────────────────                      │
│                                                                 │
│   Layer 3 (Network)      ─┐                                     │
│   Layer 2 (Data Link)     ├─ 네트워크 인프라                    │
│   Layer 1 (Physical)     ─┘                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### L4 처리 (ztunnel)

```
┌─────────────────────────────────────────────────────────────────┐
│                 ztunnel이 처리하는 것 (L4)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ✅ mTLS (상호 TLS 인증)                                       │
│      ─────────────────────                                      │
│      • SPIFFE ID 검증 (서비스 신원)                             │
│      • 트래픽 암호화                                            │
│      • 인증서 자동 갱신                                         │
│                                                                 │
│   ✅ L4 AuthorizationPolicy                                     │
│      ────────────────────────                                   │
│      • source namespace/principal 기반                          │
│      • destination IP/포트 기반                                 │
│      • ❌ 헤더, 경로 조건은 불가                                │
│                                                                 │
│   ✅ TCP 메트릭                                                 │
│      ──────────                                                 │
│      • 연결 수                                                  │
│      • 바이트 전송량                                            │
│      • 연결 지속시간                                            │
│                                                                 │
│   ✅ 기본 로드밸런싱                                            │
│      ─────────────────                                          │
│      • Round Robin                                              │
│      • 헬스체크                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### L7 처리 (waypoint)

```
┌─────────────────────────────────────────────────────────────────┐
│                waypoint가 처리하는 것 (L7)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ✅ HTTP 라우팅 (VirtualService)                               │
│      ─────────────────────────────                              │
│      • 경로 기반 라우팅 (/api/v1 → v1, /api/v2 → v2)            │
│      • 헤더 기반 라우팅                                         │
│      • 가중치 라우팅 (Canary)                                   │
│                                                                 │
│   ✅ 헤더 기반 AuthorizationPolicy                              │
│      ────────────────────────────────                           │
│      • when: request.headers["x-user-role"] == "admin"          │
│      • 경로 조건: paths: ["/admin/*"]                           │
│                                                                 │
│   ✅ JWT 인증 (RequestAuthentication)                           │
│      ──────────────────────────────────                         │
│      • JWKS 검증                                                │
│      • 클레임 기반 인가                                         │
│                                                                 │
│   ✅ 복원력 기능                                                │
│      ──────────────                                             │
│      • Retry                                                    │
│      • Timeout                                                  │
│      • Circuit Breaker (outlierDetection)                       │
│                                                                 │
│   ✅ Traffic Mirroring                                          │
│      ────────────────────                                       │
│      • Shadow Testing                                           │
│                                                                 │
│   ✅ 헤더 조작                                                  │
│      ───────────                                                │
│      • 요청/응답 헤더 추가/제거                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔀 언제 waypoint가 필요한가?

### 결정 흐름도

```
┌─────────────────────────────────────────────────────────────────┐
│               waypoint 필요 여부 결정                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                    서비스 요구사항                              │
│                          │                                      │
│           ┌──────────────┼──────────────┐                       │
│           ▼              ▼              ▼                       │
│                                                                 │
│   mTLS + 기본 AuthZ    HTTP 라우팅     JWT 인증                 │
│   (IP/포트 기반)       필요            필요                     │
│           │              │              │                       │
│           ▼              ▼              ▼                       │
│   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐         │
│   │   ztunnel     │ │   waypoint    │ │   waypoint    │         │
│   │   만으로 OK   │ │   필요        │ │   필요        │         │
│   └───────────────┘ └───────────────┘ └───────────────┘         │
│                                                                 │
│   예시:                예시:             예시:                  │
│   • 단순 gRPC 통신     • Canary 배포     • API Gateway          │
│   • 내부 DB 접근       • A/B Testing     • 사용자 인증          │
│   • 메시지 큐          • 헤더 기반 라우팅                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 실제 예시

```yaml
# L4 Only - waypoint 불필요
# mTLS + IP 기반 접근 제어만
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-frontend-only
spec:
  selector:
    matchLabels:
      app: backend
  action: ALLOW
  rules:
  - from:
    - source:
        namespaces: ["frontend"]  # L4에서 처리 가능
---
# L7 필요 - waypoint 배포 필요
# 헤더 기반 조건
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: admin-only
spec:
  selector:
    matchLabels:
      app: admin-api
  action: ALLOW
  rules:
  - when:
    - key: request.headers[x-user-role]  # L7 조건!
      values: ["admin"]
```

---

## 🔗 HBONE 프로토콜

### HBONE이란?

Ambient Mode에서 사용하는 터널링 프로토콜입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                     HBONE 프로토콜                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   HBONE = HTTP Based Overlay Network Encapsulation              │
│                                                                 │
│   특징:                                                         │
│   ═════                                                         │
│   • HTTP/2 기반 터널링                                          │
│   • HTTP CONNECT 메서드 사용                                    │
│   • mTLS로 암호화                                               │
│   • 메타데이터 전달 용이                                        │
│                                                                 │
│   왜 HBONE인가?                                                 │
│   ═════════════                                                 │
│   • Sidecar는 iptables로 모든 트래픽 가로채기 가능              │
│   • ztunnel은 Node 레벨에서 동작 → 명시적 터널 필요             │
│   • HTTP/2의 다중화(multiplexing) 활용                          │
│                                                                 │
│   패킷 구조:                                                    │
│   ═══════════                                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  [TCP/IP] [TLS(mTLS)] [HTTP/2 CONNECT] [원본 데이터]    │   │
│   │                                                         │   │
│   │  ← 암호화된 터널 ─────────────────────→ ← 실제 트래픽   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### HBONE 통신 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                  HBONE 통신 상세                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   App A ──HTTP──▶ ztunnel(A)                                    │
│                       │                                         │
│                       │ 1. 원본 패킷 캡처 (eBPF)                │
│                       │ 2. 대상 확인                            │
│                       │ 3. HBONE 터널 생성                      │
│                       │                                         │
│                       ▼                                         │
│                 [HBONE Tunnel]                                  │
│                 HTTP/2 CONNECT + mTLS                           │
│                       │                                         │
│                       │ 4. 대상 Node의 ztunnel로 전송           │
│                       │                                         │
│                       ▼                                         │
│                  ztunnel(B)                                     │
│                       │                                         │
│                       │ 5. HBONE 디캡슐화                       │
│                       │ 6. 원본 패킷 추출                       │
│                       │                                         │
│                       ▼                                         │
│                    App B                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ⚖️ Sidecar vs Ambient 상세 비교

### 아키텍처 비교

```
┌─────────────────────────────────────────────────────────────────┐
│                Sidecar vs Ambient 아키텍처                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Sidecar 방식                                                  │
│   ════════════                                                  │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                       Pod                               │   │
│   │  ┌─────────────────┐    ┌─────────────────┐             │   │
│   │  │   Application   │◀──▶│  Envoy Sidecar  │             │   │
│   │  │                 │    │   (L4 + L7)     │             │   │
│   │  └─────────────────┘    └────────┬────────┘             │   │
│   │                                  │                      │   │
│   │                          iptables 리다이렉트             │   │
│   └──────────────────────────────────┼──────────────────────┘   │
│                                      │                          │
│                                      ▼                          │
│                                  Network                        │
│                                                                 │
│   • 모든 트래픽이 Sidecar 경유                                  │
│   • L4 + L7 모두 같은 Envoy에서 처리                            │
│   • Pod당 Sidecar 필요                                          │
│                                                                 │
│   ─────────────────────────────────────────────────────────     │
│                                                                 │
│   Ambient 방식                                                  │
│   ════════════                                                  │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                       Pod                               │   │
│   │  ┌─────────────────────────────────────────┐            │   │
│   │  │              Application                │            │   │
│   │  │           (Sidecar 없음!)               │            │   │
│   │  └─────────────────────────────────────────┘            │   │
│   └──────────────────────────┬──────────────────────────────┘   │
│                              │                                  │
│                              │ eBPF 리다이렉트                  │
│                              ▼                                  │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │                 ztunnel (DaemonSet)                      │  │
│   │                      L4 처리                             │  │
│   └──────────────────────────┬───────────────────────────────┘  │
│                              │                                  │
│                              │ (L7 필요시)                      │
│                              ▼                                  │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │               waypoint (Deployment)                      │  │
│   │                      L7 처리                             │  │
│   └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│   • L4/L7 분리                                                  │
│   • L7 필요시에만 waypoint 경유                                 │
│   • Node당 ztunnel 1개                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 트래픽 경로 비교

```
┌─────────────────────────────────────────────────────────────────┐
│                    트래픽 경로 비교                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Sidecar 방식 (모든 요청)                                      │
│   ══════════════════════════                                    │
│                                                                 │
│   App A → Sidecar A → Network → Sidecar B → App B               │
│           (Envoy)                 (Envoy)                       │
│           L4+L7                   L4+L7                         │
│                                                                 │
│   홉 수: 4 (App → Sidecar → Sidecar → App)                      │
│   처리: 양쪽에서 전체 스택 처리                                 │
│                                                                 │
│   ─────────────────────────────────────────────────────────     │
│                                                                 │
│   Ambient 방식 (L4 Only)                                        │
│   ══════════════════════                                        │
│                                                                 │
│   App A → ztunnel A → Network → ztunnel B → App B               │
│           (Rust)                  (Rust)                        │
│            L4                      L4                           │
│                                                                 │
│   홉 수: 4 (동일)                                               │
│   처리: L4만 처리 → 더 빠름                                     │
│                                                                 │
│   ─────────────────────────────────────────────────────────     │
│                                                                 │
│   Ambient 방식 (L7 필요)                                        │
│   ══════════════════════                                        │
│                                                                 │
│   App A → ztunnel A → waypoint → ztunnel B → App B              │
│           (L4)         (L7)       (L4)                          │
│                                                                 │
│   홉 수: 5 (waypoint 추가)                                      │
│   처리: L7 필요한 경우만 waypoint 경유                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 리소스 비교

```
┌─────────────────────────────────────────────────────────────────┐
│                    리소스 사용량 비교                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   시나리오: Pod 100개, Node 5개                                 │
│                                                                 │
│   Sidecar 방식                                                  │
│   ════════════                                                  │
│   • Envoy Sidecar 100개                                         │
│   • CPU: 100m × 100 = 10,000m (10 CPU)                          │
│   • Memory: 128Mi × 100 = 12.8Gi                                │
│                                                                 │
│   Ambient 방식 (L4 Only)                                        │
│   ══════════════════════                                        │
│   • ztunnel 5개 (Node당 1개)                                    │
│   • CPU: 100m × 5 = 500m (0.5 CPU)                              │
│   • Memory: 256Mi × 5 = 1.28Gi                                  │
│                                                                 │
│   절감: CPU 95%, Memory 90%                                     │
│                                                                 │
│   Ambient 방식 (L7 포함)                                        │
│   ══════════════════════                                        │
│   • ztunnel 5개                                                 │
│   • waypoint 2개 (필요한 서비스만)                              │
│   • CPU: 500m + 200m = 700m                                     │
│   • Memory: 1.28Gi + 256Mi = 1.5Gi                              │
│                                                                 │
│   절감: CPU 93%, Memory 88%                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔧 ztunnel 상세

### ztunnel 특징

```
┌─────────────────────────────────────────────────────────────────┐
│                     ztunnel 특징                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   언어: Rust                                                    │
│   ═══════════                                                   │
│   • 메모리 안전성                                               │
│   • C++ 수준의 성능                                             │
│   • 낮은 메모리 사용량                                          │
│                                                                 │
│   트래픽 인터셉트: eBPF                                         │
│   ═══════════════════════                                       │
│   • 커널 레벨에서 직접 리다이렉트                               │
│   • iptables보다 효율적                                         │
│   • 낮은 레이턴시                                               │
│                                                                 │
│   배포: DaemonSet                                               │
│   ═══════════════                                               │
│   • 모든 Node에 1개씩                                           │
│   • hostNetwork: true                                           │
│   • Node의 모든 Pod 트래픽 처리                                 │
│                                                                 │
│   확장성                                                        │
│   ═══════                                                       │
│   • Pod 수 증가해도 ztunnel 수는 Node 수로 고정                 │
│   • Node 추가 시에만 ztunnel 추가                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### ztunnel 모니터링

```bash
# ztunnel Pod 확인
$ kubectl get pods -n istio-system -l app=ztunnel

# ztunnel 로그
$ kubectl logs -n istio-system -l app=ztunnel

# ztunnel 메트릭
$ kubectl exec -n istio-system deploy/ztunnel -- \
    curl localhost:15020/stats/prometheus
```

---

## 📊 정리: L4에서 되는 것 vs L7이 필요한 것

```
┌─────────────────────────────────────────────────────────────────┐
│            L4 (ztunnel) vs L7 (waypoint) 기능 분류              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   L4에서 되는 것 (ztunnel)          L7이 필요한 것 (waypoint)   │
│   ═══════════════════════           ═══════════════════════     │
│                                                                 │
│   ✅ mTLS (암호화, 인증)            ✅ VirtualService 라우팅    │
│   ✅ SPIFFE ID 검증                 ✅ 헤더 기반 라우팅         │
│   ✅ namespace/principal 기반 AuthZ ✅ 가중치 라우팅 (Canary)   │
│   ✅ IP/포트 기반 AuthZ             ✅ 헤더 기반 AuthZ          │
│   ✅ TCP 메트릭                     ✅ JWT 인증                 │
│   ✅ 기본 로드밸런싱                ✅ Retry, Timeout           │
│                                     ✅ Circuit Breaker          │
│                                     ✅ Traffic Mirroring        │
│                                     ✅ 헤더 조작                │
│                                     ✅ HTTP 메트릭              │
│                                                                 │
│   waypoint 없이 가능                waypoint 필요               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 핵심 정리

| 구분 | ztunnel (L4) | waypoint (L7) |
|------|--------------|---------------|
| **배포** | DaemonSet (Node당 1개) | Deployment (필요시) |
| **언어** | Rust | Envoy (C++) |
| **처리** | mTLS, 기본 AuthZ | 라우팅, JWT, Retry |
| **성능** | 매우 빠름 | Sidecar와 유사 |
| **필수 여부** | 항상 필요 | L7 기능 시에만 |

### 언제 무엇을 사용?

| 시나리오 | 필요한 것 |
|----------|-----------|
| mTLS만 필요 | ztunnel만 |
| IP 기반 접근 제어 | ztunnel만 |
| HTTP 라우팅 필요 | ztunnel + waypoint |
| JWT 인증 필요 | ztunnel + waypoint |
| Canary 배포 | ztunnel + waypoint |

---

## 🔗 다음 편 예고

Part 3에서는 **Sidecar vs Ambient 기능 비교 (2024.12 기준)**를 다룹니다:
- 멀티클러스터 미지원 등 현재 제한사항
- EnvoyFilter 대안
- Ambient 선택 기준

---

## 🔗 참고 자료

- [Istio ztunnel](https://istio.io/latest/docs/ambient/architecture/ztunnel/)
- [Istio waypoint](https://istio.io/latest/docs/ambient/architecture/waypoint/)
- [HBONE Protocol](https://istio.io/latest/docs/ambient/architecture/hbone/)
- [ztunnel Source (Rust)](https://github.com/istio/ztunnel)
